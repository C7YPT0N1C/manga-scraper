#!/usr/bin/env bash
set -e

# ===============================
# ROOT CHECK
# ===============================
if [[ $EUID -ne 0 ]]; then
    echo "[!] Please run as root: sudo ./nhscraper-install.sh --install"
    exit 1
fi

# ===============================
# VARIABLES
# ===============================
NHENTAI_DIR="/opt/nhentai-scraper"
SUWAYOMI_DIR="/opt/suwayomi"
FILEBROWSER_BIN="/usr/local/bin/filebrowser"
ENV_FILE="$NHENTAI_DIR/nhentai-scraper.env"

# ===============================
# INSTALL FUNCTIONS
# ===============================
function check_python_version()
    PYTHON_VERSION=$(python3 -c 'import sys; print(".".join(map(str, sys.version_info[:2])))')
    REQUIRED_VERSION="3.9"
    if [[ $(echo -e "$PYTHON_VERSION\n$REQUIRED_VERSION" | sort -V | head -n1) != "$REQUIRED_VERSION" ]]; then
        echo "[!] Python 3.9+ required. Detected: $PYTHON_VERSION"
        exit 1
    fi
}

function install_system_packages() {
    echo "[*] Installing system packages..."
    apt-get update
    apt-get install -y python3 python3-pip python3-venv git build-essential curl wget dnsutils tor torsocks
    echo "[+] System packages installed."
}    

function install_scraper() {
    echo "[*] Installing nhentai-scraper..."
    mkdir -p "$NHENTAI_DIR"
    cd "$NHENTAI_DIR"

    read -p "Install Beta Version instead of Stable? [y/N]: " beta
    branch="main"
    [[ "$beta" =~ ^[yY] ]] && branch="dev"

    if [ ! -d "$NHENTAI_DIR/.git" ]; then
        echo "[*] Cloning nhentai-scraper..."
        if git clone --depth 1 --branch "$branch" https://code.zenithnetwork.online/C7YPT0N1C/nhentai-scraper.git "$NHENTAI_DIR"; then
            echo "[+] Cloned from Gitea."
        else
            echo "[!] Gitea clone failed, trying GitHub..."
            if ! git clone --depth 1 --branch "$branch" https://github.com/C7YPT0N1C/nhentai-scraper.git "$NHENTAI_DIR"; then
                echo "[!] Both clone attempts failed. Please check your network connection."
                exit 1
            fi
        fi
    else
        git pull || echo "[!] Could not update scraper repo."
    fi

    if [ ! -d "$NHENTAI_DIR/venv" ]; then
        echo "[*] Creating venv..."
        python3 -m venv "$NHENTAI_DIR/venv"
        source "$NHENTAI_DIR/venv/bin/activate"
        "$NHENTAI_DIR/venv/bin/pip" install --upgrade pip setuptools wheel
    else
        source "$NHENTAI_DIR/venv/bin/activate"
    fi

    # Install via pyproject.toml (editable mode)
    pip install -e .

    install_python_packages

    # Create/refresh global symlink
    ln -sf "$NHENTAI_DIR/venv/bin/nh-scraper" /usr/local/bin/nh-scraper
    echo "[+] Global command 'nh-scraper' installed."
}

function update_all() {
    echo "[*] Updating nhentai-scraper and Suwayomi..."
    install_scraper
    install_suwayomi
    ln -sf "$NHENTAI_DIR/venv/bin/nh-scraper" /usr/local/bin/nh-scraper # refresh symlink

    echo "[*] Restarting services..."
    systemctl restart suwayomi filebrowser nhentai-api
    echo "[*] Update complete!"
}

# ===============================
# MAIN
# ===============================
check_python_version

echo "===================================================="
echo "           nhentai-scraper INSTALLER               "
echo "===================================================="
echo ""
echo "This installer will install, update, or uninstall the following components:"
echo "- C7YPT0N1C/nhentai-scraper"
echo "- Suwayomi Server"
echo "- FileBrowser"
echo ""
read -p "Do you want to proceed? [y/N]: " consent

case "$consent" in
    [yY]|[yY][eE][sS]) echo "[*] Consent given. Continuing..." ;;
    *) echo "[!] Operation cancelled by user."; exit 0 ;;
esac

if [[ "$1" == "--install" ]]; then
    start_install
    exit 0
elif [[ "$1" == "--update" ]]; then
    update_all
    print_links
    exit 0
elif [[ "$1" == "--update-env" ]]; then
    update_env
    exit 0
elif [[ "$1" == "--uninstall" ]]; then
    uninstall_all
    exit 0
fi